var BgCtrl=function(){var e,t,n,o,a,r="longerBreak",s="exceptions",i="notification",c="autoStart",u="cleanBlockPage",l="pauseDuration",d="localOptions",m="useCustomSound",g="soundData",k="isPaused",f="previousTimestamp",p="elapsedTime",h="pauseTimestamp",b="chrome-extension://"+chrome.i18n.getMessage("@@extension_id")+"/block-page.html",w="chrome-extension://"+chrome.i18n.getMessage("@@extension_id")+"/block-page.html",S="img/icon-green-128.png",B={color:"#B71C1C"},v={color:"#1B5E20"},T={color:"#0D47A1"},y=/(?:^https?:\/\/)?(?:www\.)?(.+?)(?:[/]*$)/i,C=function(e){var t={};if(t.time=e.time,t.break=e.break,t[r]=e[r],t.serie=e.serie,t.badge=e.badge,t[i]=e[i],t.block=e.block,t.audio=e.audio,t[c]=e[c],t[u]=e[u],t.hidePause=e.hidePause,t.hideStop=e.hideStop,t.noStats=e.noStats,t[l]=e[l],e.sites){t.sites=[];for(var n=0;n<e.sites.length;n++)t.sites.push(e.sites[n])}if(e[s])for(t[s]=[],n=0;n<e[s].length;n++)t[s].push(e[s][n]);if(e[d]){var o={},a=e[d];o.soundName=a.soundName,o[g]=a[g],o[m]=a[m],t[d]=o}return t},I=function(n){(t=C(e=n||e)).sites=[];for(var o=0;o<e.sites.length;o++)e.sites[o]&&t.sites.push(D(e.sites[o]));for(t[s]=[],o=0;o<e[s].length;o++)e[s][o]&&t[s].push(D(e[s][o]))},D=function(e){var t;return(t=e.match(y))?t[1]:e},x=function(e){var n;return n=!function(e){for(var n=0;n<t[s].length;n++)if(0===e.indexOf(t[s][n]))return!0;return!1}(e)&&!1!==function(e){for(var n=0;n<t.sites.length;n++)if(0===e.indexOf(t.sites[n]))return!0;return!1}(e),t.block?n:!n},L=function(e){var r=D(e.url),s=t[u]?w:b;n&&!o.isBreak&&x(r)&&chrome.tabs.update(e.id,{url:s},(function(){chrome.runtime.lastError&&window.setTimeout((function(){chrome.tabs.update(e.id,{url:s},(function(){chrome.runtime.lastError}))}),800),!1===t.noStats&&(Stats.addBlockedURL(a,r),Stats.save(a))}))},P=function(e){chrome.tabs.query({},(function(t){switch(e){case"block":t.forEach((function(e){L({id:e.id,windowId:e.windowId,url:e.url})}));break;case"unblock":t.forEach((function(e){!e||e.url!==b&&e.url!==w||chrome.tabs.sendMessage(e.id,{})}))}}))},O=function(e){if(t[i]&&chrome.notifications.create(e),t.audio){var n=new Audio,o=t[d];o&&o[m]&&o[g]?n.src=o[g]:n.src="audio/bell.wav",n.play()}},A=function(e,n){var o=e;"string"!=typeof o&&(o=o.toString()),t.badge&&(n&&chrome.browserAction.setBadgeBackgroundColor(n),chrome.browserAction.setBadgeText({text:o}))},E=function(e){switch(e){case"work":chrome.browserAction.setIcon({path:{38:"img/icon-red-38.png",19:"img/icon-red-19.png"}});break;case"break":case"longBreak":chrome.browserAction.setIcon({path:{38:"img/icon-blue-38.png",19:"img/icon-blue-19.png"}});break;case"disabled":chrome.browserAction.setIcon({path:{38:"img/icon-green-38.png",19:"img/icon-green-19.png"}});case"paused":chrome.browserAction.setIcon({path:{38:"img/icon-green-38.png",19:"img/icon-green-19.png"}})}},U=function(){var e=Date.now(),n=e-o[f];!1===t.noStats&&(o.isBreak?Stats.set(a,"totalBreakTime",a.totalBreakTime+n):Stats.set(a,"totalWorkTime",a.totalWorkTime+n)),o[p]+=n,o[f]=e;var r=Math.ceil(o.total-o[p]/1e3/60);A(r.toString()),o[p]/1e3/60>=o.total&&(t.break?(W(),t[c]||Y("pause")):(O({type:"basic",iconUrl:S,title:"Well done!",message:"You can access your blocked websites now."}),Y("stop")))},M=function(){return!t.serie||o.executions%t.serie!=0},W=function(){o[p]=0,o.isBreak?(P("block"),o.isBreak=!1,o.total=t.time,O({type:"basic",iconUrl:S,title:"Time to Work",message:"You need to work for "+o.total+" more minutes."}),A(o.total.toString(),B),E("work"),!1===t.noStats&&Stats.set(a,"breakCycles",a.breakCycles+1)):(P("unblock"),o.isBreak=!0,o.executions+=1,M()?(o.breakType="short",o.total=t.break,O({type:"basic",iconUrl:S,title:"Break Time",message:"You can take a "+o.total+" minutes break now."}),A(o.total.toString(),v),E("break")):(o.breakType="long",o.total=t[r]||t.break,O({type:"basic",iconUrl:S,title:"Time for a Longer Break",message:"You can take a "+o.total+" minutes break now."}),A(o.total.toString(),T),E("longBreak")),!1===t.noStats&&Stats.set(a,"workCycles",a.workCycles+1))},Y=function(e){switch(e){case"start":n=!0,I(),(o={}).id=window.setInterval(U,2e3),o[f]=Date.now(),o[p]=0,o.isBreak=!1,o[k]=!1,o.executions=0,o.total=t.time,A(o.total.toString(),B),!1===t.noStats&&(a=Stats.factory(),Stats.set(a,{startTime:Date.now(),workLength:t.time,breakLength:t.break,longerBreakLength:t[r],serie:t.serie})),P("block"),E("work");break;case"stop":n=!1,function(){if(window.clearInterval(o.id),A(""),o[k]){var e=Date.now()-o[h];!1===t.noStats&&Stats.set(a,"totalPauseTime",a.totalPauseTime+e)}o=null}(),P("unblock"),E("disabled");break;case"pause":n=!1,window.clearInterval(o.id),o.id=void 0,o[k]=!0,o[h]=Date.now(),A("P"),!1===t.noStats&&Stats.set(a,"pauses",a.pauses+1),P("unblock"),E("paused");break;case"resume":n=!0,function(){o.id=window.setInterval(U,2e3),o[f]=Date.now(),o[k]=!1;var e=Date.now()-o[h];o[h]=void 0,U(),!1===t.noStats&&Stats.set(a,"totalPauseTime",a.totalPauseTime+e)}(),o.isBreak?(M()?E("break"):E("longBreak"),P("unblock")):(E("work"),P("block"))}},N=function(){return n},F=function(){return o&&o[k]};return{init:function(e){I(e),A(""),E("disabled")},update:L,getDefaultOptions:function(){var e={time:60,break:15,serie:4,longerBreak:45,badge:!0,notification:!0,block:!0,audio:!1,autoStart:!0,cleanBlockPage:!1,hidePause:!1,hideStop:!1,noStats:!0,pauseDuration:-1,sites:["youtube.com","facebook.com","instagram.com","web.whatsapp.com","twitter.com","reddit.com"],exceptions:[]};return e},getDefaultLocalOptions:function(){return["soundName",g]},getOptions:function(){return C(e)},saveOptions:function(t){if(e=Object.assign({},t),t[d]){var n=t[d];delete t[d],chrome.storage.local.set(n,(function(){chrome.runtime.lastError}))}chrome.storage.sync.set(t,(function(){chrome.runtime.lastError}))},changeState:Y,getTimerInformation:function(){return o},getBlockedSites:function(){return t.sites},isExecuting:N,isPaused:F,skipBreak:function(){n&&o.isBreak&&W(),!1===t.noStats&&("short"===o.breakType?Stats.set(a,"skippedBreaks",a.skippedBreaks+1):Stats.set(a,"skippedLongBreaks",a.skippedLongBreaks+1))},handleCommand:function(e){var t=F(),n=N();"start"===e?Y(n||t?"stop":"start"):"pause"===e&&n&&Y(t?"resume":"pause")},checkFeatures:function(e){return Storage.get(e,"sync")},enableFeatures:function(e){return Storage.set(e,"sync")}}}();!function(){var e={},t=[];Storage.get(BgCtrl.getDefaultOptions(),"sync").then((function(t){return e=t,Storage.get(BgCtrl.getDefaultLocalOptions(),"local")})).then((function(t){return e.localOptions=t,Storage.get("statsIds","local")})).then((function(e){t=e.statsIds,Stats.init(e.statsIds)})).then((function(){BgCtrl.init(e),chrome.runtime.onConnect.addListener((function(e){"checking-channel"===e.name&&e.onMessage.addListener((function(t){t.id=e.sender.tab.id,t.windowId=e.sender.tab.windowId,BgCtrl.update(t)}))})),chrome.commands.onCommand.addListener((function(e){BgCtrl.handleCommand(e)})),window.StatsTest&&0===(t||[]).length&&window.StatsTest.insertData()}))}(),chrome.runtime.onInstalled.addListener((function(e){"install"===e.reason&&chrome.tabs.create({url:"https://drewtools.com/api/install"})})),chrome.runtime.setUninstallURL("https://drewtools.com/uninstall/");