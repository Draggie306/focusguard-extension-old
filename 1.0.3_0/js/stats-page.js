var StatsPage=function(){var e,t,a,n,r,s,o,i="blockedFrequency",l="skippedBreaks",c="totalWorkTime",d="totalBreakTime",m="totalPauseTime",u="yyyymmddhhmmss",b="table-actions",g=function(){var t=document.getElementById.bind(document);t("select-view-time").addEventListener("change",(function(){var e=Number(this.value);localStorage&&localStorage.setItem("days",e),y(e)})),t("bt-view-by-day").addEventListener("click",(function(){E(a,"day")})),t("bt-view-by-week").addEventListener("click",(function(){E(a,"week")})),t("bt-view-by-month").addEventListener("click",(function(){E(a,"month")})),t("bt-erase-all-data").addEventListener("click",(function(){confirm(chrome.i18n.getMessage("statsErrorEraseAllData"))&&(e.removeAllItems(),location.reload())}))},y=function(r){if(void 0===n||n!==r){var s=r||15;return e.getByLastDays(s).then((function(e){a=e,n=r,t=void 0,v(e)}))}},v=function(e){S(e),E(e,"day"),h(e)},h=function(e){var t=N(e,5),a=document.getElementById("most-blocked-list"),n=document.createDocumentFragment();!function(e){for(;e.firstChild;)e.removeChild(e.firstChild)}(a);for(var r=t.length-1;r>=0;r--){var s=document.createElement("li");s.className="list-element",s.textContent=t[r][0]+" "+t[r][1],n.appendChild(s)}a.appendChild(n)},f=function(e){var t=chrome.i18n.getMessage.bind(chrome.i18n);return[t("Jan"),t("Feb"),t("Mar"),t("Apr"),t("May"),t("Jun"),t("Jul"),t("Aug"),t("Sept"),t("Oct"),t("Nov"),t("Dec")][e-1]},k=function(t){var a=e.getLocalDateParts(t),n=a[1].toString();1===n.length&&(n="0"+n);var r=a[2].toString();1===r.length&&(r="0"+r);var s=a[3].toString();1===s.length&&(s="0"+s);var o=a[4].toString();return 1===o.length&&(o="0"+o),a[0].toString()+"/"+n+"/"+r+" - "+s+":"+o},p=function(e){var t=e/1e3,a="",n=parseInt(t%60);t/=60;var r=parseInt(t%60);t/=60;var s=parseInt(t%24);t/=24;var o=parseInt(t);return 0!==o&&(a+=o+"d"),0!==s&&(a+=" "+s+"h"),0!==r&&(a+=" "+r+"m"),0!==n&&(a+=" "+n+"s"),""!==(a=a.trim())?a:"0"},w=function(e,t){var a=/(?:([0-9]+)d)?\s*(?:([0-9]+)h)?\s*(?:([0-9]+)m)?\s*(?:([0-9]+)s)?/,n=e.match(a),r=t.match(a);n[1]=24*Number(n[1]||0)*60*60,n[2]=60*Number(n[2]||0)*60,n[3]=60*Number(n[3]||0),n[4]=Number(n[4]||0);var s=n[1]+n[2]+n[3]+n[4];return r[1]=24*Number(r[1]||0)*60*60,r[2]=60*Number(r[2]||0)*60,r[3]=60*Number(r[3]||0),r[4]=Number(r[4]||0),s-(r[1]+r[2]+r[3]+r[4])},T=function(e){for(var t=0,a=0;a<e.length;a++)t+=e[a];return t},B=function(e,t){return{title:e,data:t}},C=function(){var t=$("#stats-table").DataTable(),a=t.rows(".selected").ids().toArray();a.length&&e.removeItems(a).then((function(){t.rows(".selected").remove().draw(!1),L()}))},L=function(e,t,a){void 0!==a&&"row"!==a||($("#stats-table").DataTable().rows(".selected").ids().toArray().length?(document.getElementById(b).style.visibility="visible",document.getElementById(b).style.transition="opacity 100ms",document.getElementById(b).style.opacity="1"):(document.getElementById(b).style.visibility="hidden",document.getElementById(b).style.opacity="0",document.getElementById(b).style.transition="visibility 0ms 100ms, opacity 100ms"))},S=function(e){var t=chrome.i18n.getMessage.bind(chrome.i18n);r&&($("#bt-remove-rows").off("click",C),r.off("select",L),r.off("deselect",L),r.rows().deselect(),L(),r.destroy()),r=$("#stats-table").DataTable({lengthChange:!1,data:function(e,t){for(var a=[],n=e.length,r=0;r<n;r++){var s={selection:""};s.DT_RowId=e[r].id,s.startTime=k(e[r][u]),s.workCycles=e[r].workCycles,s[c]=p(e[r][c]),s.breakCycles=e[r].breakCycles,s[d]=p(e[r][d]),s.pauses=e[r].pauses,s[m]=p(e[r][m]),s[l]=e[r][l]+e[r].skippedLongBreaks,s[i]=T(e[r][i]),a.push(s)}return a}(e),columns:[B("","selection"),B(t("statsColumnStartDate"),"startTime"),B(t("statsColumnWorkCycles"),"workCycles"),B(t("statsColumnWorkTime"),c),B(t("statsColumnBreakCycles"),"breakCycles"),B(t("statsColumnBreakTime"),d),B(t("statsColumnPauses"),"pauses"),B(t("statsColumnPauseTime"),m),B(t("statsColumnSkippedBreaks"),l),B(t("statsColumnBlocks"),i)],columnDefs:[{orderable:!1,className:"select-checkbox",targets:0},{width:"15%",targets:1},{type:"time-str",targets:3},{type:"time-str",targets:5},{type:"time-str",targets:7}],select:{style:"multi+shift",selector:"td:first-child"},order:[[1,"desc"]],language:{searchPlaceholder:"Search",search:""}}),$.extend($.fn.dataTableExt.oSort,{"time-str-asc":w,"time-str-desc":function(e,t){return-1*w(e,t)}}),$("#bt-remove-rows").click(C),r.on("select",L),r.on("deselect",L)},I=function(t,a){var n=e.getLocalDateParts(t);switch(a){case"day":return[parseInt(t/1e6),f(n[1])+" "+n[2].toString()];case"week":var r=DateUtils.getWeekNumber(n[2],n[1]-1,n[0]);return[100*r[0]+r[1],r[0].toString()+" w"+r[1].toString()];case"month":return[parseInt(t/1e8),f(n[1])];case"year":return[parseInt(t/1e10),n[2].toString()];default:return[parseInt(t/1e6),n[1].toString()+" "+n[0].toString()]}},M=function(e){return Math.round(e/1e3/60/60)},E=function(e,a){if(void 0===t||t!==a){s&&s.destroy(),o&&o.destroy(),t=a;var n=function(e,t){for(var a={labels:[],workTime:[],breakTime:[],blocks:[]},n=0;n<e.length;){for(var r=I(e[n][u],t),s=r[0],o=r[1],l=e[n][c],m=e[n][d],b=T(e[n][i]),g=n+1;g<e.length&&I(e[g][u],t)[0]===s;)l+=e[g][c],m+=e[g][d],b+=T(e[g][i]),g++;a.labels.push(o),a.workTime.push(M(l)),a.breakTime.push(M(m)),a.blocks.push(b),n=g}return a}(e,a||"day");D(n),H(n)}},D=function(e){var t=document.getElementById("time-graph").getContext("2d");s=new Chart(t,{type:"bar",data:{labels:e.labels,datasets:[{label:"Work time",data:e.workTime,backgroundColor:"rgba(255, 99, 132, 0.2)",borderColor:"rgba(255,99,132,1)",borderWidth:1},{label:"Idle time",data:e.breakTime,backgroundColor:"rgba(75, 192, 192, 0.2)",borderColor:"rgba(75, 192, 192, 1)",borderWidth:1}]},options:{scales:{yAxes:[{ticks:{beginAtZero:!0}}]}}})},H=function(e){var t=document.getElementById("blocks-graph").getContext("2d");o=new Chart(t,{type:"bar",data:{labels:e.labels,datasets:[{label:"# of blocked accesses",data:e.blocks,borderWidth:1}]},options:{scales:{yAxes:[{ticks:{beginAtZero:!0}}]}}})},N=function(e,t){var a={},n=[];if(0===t||0===e.length)return n;for(var r=0;r<e.length;r++)for(var s=0;s<e[r].blockedUrls.length;s++){var o=e[r].blockedUrls[s];void 0!==a[o]?a[o]+=e[r][i][s]:a[o]=e[r][i][s]}var l=Object.keys(a);for(r=0;r<l.length&&r<t;r++)n.push([l[r],a[l[r]]]);for(;r<l.length;r++){var c=0;for(s=0;s<n.length;s++)n[s][1]<n[c][1]&&(c=s);n[c][1]<a[l[r]]&&(n[c][0]=l[r],n[c][1]=a[l[r]])}return n.sort((function(e,t){return e[1]-t[1]})),n};return{init:function(t){e=t.Stats,t.BgCtrl.getOptions().noStats&&(document.getElementById("no-stats-message").innerHTML="(OFF)",document.getElementById("no-stats-message").classList.remove("hidden")),function(){var e=document.getElementById.bind(document),t=chrome.i18n.getMessage.bind(chrome.i18n);document.title=t("statsTitle"),e("navbar-title").innerHTML=t("statsNavbarTitle"),e("label-select-view-time").innerHTML=t("statsLabelSelectViewTime"),e("option-15-days").innerHTML=t("statsSelect15Days"),e("option-30-days").innerHTML=t("statsSelect30Days"),e("option-90-days").innerHTML=t("statsSelect90Days"),e("option-180-days").innerHTML=t("statsSelect180Days"),e("bt-value-remove-rows").innerHTML=t("statsButtonRemoveRows"),e("header-most-blocked-list").innerHTML=t("statsHeaderMostBlockedList"),e("label-view-by").innerHTML=t("statsLabelViewBy"),e("bt-view-by-day").innerHTML=t("statsButtonViewByDay"),e("bt-view-by-week").innerHTML=t("statsButtonViewByWeek"),e("bt-view-by-month").innerHTML=t("statsButtonViewByMonth"),e("label-time-graph").innerHTML=t("statsLabelTimeGraph"),e("label-blocks-graph").innerHTML=t("statsLabelBlocksGraph"),e("bt-value-erase-all-data").innerHTML=t("statsButtonEraseAllData")}();var a=15;localStorage&&localStorage.getItem("days")&&(a=Number(localStorage.getItem("days")),document.getElementById("select-view-time").value=a),y(a).then(g)}}}();document.addEventListener("DOMContentLoaded",(function(){chrome.runtime.getBackgroundPage(StatsPage.init)}));